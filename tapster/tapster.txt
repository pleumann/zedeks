#program tapster  10 REM =======================  20 REM === Setup =============  30 REM =======================  40 RUN AT 3    50 CLEAR 32511  60 PROC Pokes()  70 PROC Window(1,1,6,30,"Tapster")    80 PROC Window(10,1,21,30,"0K in 0 file(s)")  90 CLOSE # 3: OPEN # 3,"w>11,2,10,28,4": LPRINT ; CHR$ 19; CHR$ 1; CHR$ 1; 100 LPRINT "Tapster Version 0.5" 110 LPRINT "(c) 2020 Joerg Pleumann" 120 LPRINT  130 DEF FN d(x)= INT (x/256) 140 DEF FN m(x)=x-256* INT (x/256) 150 PRINT AT 2,2; BRIGHT 1;"Start"," [X]Overwrite"; 160 PRINT AT 3,2; BRIGHT 1;"Directory"," [X]Fix name"; 170 PRINT AT 4,2; BRIGHT 1;"Help"," [X]Add suffix"; 180 PRINT AT 5,2; BRIGHT 1;"Quit"," [X]Headerless"; 190 DIM o(4): LET o(1)=1: LET o(2)=1: LET o(3)=1: LET o(4)=1 200 LET mrow=0: LET mcol=0: LET mrow2=0: LET mcol2=0 210 LPRINT "Directory is ";: PWD #3 220 PROC Message(0) 230 REM ======================= 240 REM === Menu navigation === 250 REM ======================= 260 POKE 22528+65+mrow*32+mcol*15,"xxxxxxxxxxxxxxx" 270 POKE 22528+65+mrow2*32+mcol2*15,"hhhhhhhhhhhhhhh" 280 LET mrow=mrow2: LET mcol=mcol2 290 PAUSE 0: LET k$= INKEY$ : BEEP 0.015,-20 300 IF k$= CHR$ 8 AND mcol>0 THEN mcol2=0: GO TO %260 310 IF k$= CHR$ 9 AND mcol<1 THEN mcol2=1: GO TO %260 320 IF k$= CHR$ 10 AND mrow<3 THEN mrow2=mrow+1: GO TO %260 330 IF k$= CHR$ 11 AND mrow>0 THEN mrow2=mrow-1: GO TO %260 340 IF k$<> CHR$ 13 THEN GO TO %290 350 IF mcol=1 THEN LET o(mrow+1)=1-o(mrow+1): PRINT AT 2+mrow,18; BRIGHT 1;" X"(o(mrow+1)+1);: GO TO %270 360 IF mrow=1 THEN PROC Directory(): GO TO %210 370 IF mrow=2 THEN PROC Help(): GO TO %280 380 IF mrow=3 THEN RUN AT 0: STOP  390 REM ======================= 400 REM === Main converter ==== 410 REM ======================= 420 PROC Message(1) 430 LET bytes=0: LET files=0 440 LET overwrite=o(1): LET fixnames=o(2): LET suffix=o(3): LET headerless=o(4) 450 PRINT AT 10,2; PAPER 0; INK 7; BRIGHT 1; INT (bytes/1024);"K in ";files;" file(s)     "; 460 RUN AT 0 470 LET e= USR tape 480 RUN AT 3 490 IF INKEY$ =" " THEN GO TO %220 500 IF e>32768 THEN GO TO %460 510 DPOKE check+4,e 520 LET sum= USR check 530 IF PEEK (start+e)<> FN m(sum) THEN LPRINT "Checksum error": GO TO %460 540 IF PEEK (start-1)=0 AND e=17 THEN GO TO %640 550 IF PEEK (start-1)=0 OR headerless=0 THEN GO TO %450 560 LPRINT  570 LET t= 5 580 LET n$="Headerless" 590 LET l=e 600 LET a=32768 610 LET b=32768 620 LPRINT n$;" (length=";l;")" 630 GO TO %870 640 LET t= PEEK start 650 LET n$= PEEK$ (start+1,10) 660 LET l= % DPEEK (s+11) 670 LET a= % DPEEK (s+13) 680 LET b= % DPEEK (s+15) 690 IF LEN (n$)<>0 AND n$( LEN n$)=" " THEN n$=n$( TO LEN n$-1): GO TO %690 700 LPRINT  710 IF t=0 THEN LPRINT "Program: ";: ELSE IF t=1 THEN LPRINT "Numeric array: ";: ELSE IF t=2 THEN LPRINT "Character array: ";: ELSE LPRINT "Bytes: "; 720 LPRINT n$;" (size ";l; 730 IF t=0 AND (a<=9999) THEN LPRINT ", line ";a; 740 IF t=0 AND b<l THEN LPRINT ", vars"; 750 IF t=1 OR t=2 THEN LET %n=a: LET nn=%((n/256)&31)+96: LPRINT ", name "; CHR$ nn;: IF t=2 THEN LPRINT "$"; 760 IF t=4 THEN LPRINT ", addr ";a 770 LPRINT ")" 780 IF t=5 THEN GO TO %870 790 RUN AT 0 800 LET e= USR tape 810 RUN AT 3 820 IF e<>l THEN LPRINT "Length error": GO TO %460 830 DPOKE check+4,e 840 LET sum= USR check 850 IF PEEK (start+e)<> FN m(sum) THEN LPRINT "Checksum error": GO TO %460 860 IF INKEY$ =" " THEN GO TO %220 870 BORDER 7 880 PROC DiskName(t,n$,l) TO n$ 890 LPRINT "Saving as """;n$;"""..." 900 SAVE n$ CODE start,l 910 CLOSE # 5 920 OPEN # 5,"u>"+n$ 930 LET c=0 940 FOR n=0 TO 127 950 NEXT #5 TO %x 960 POKE start+n,%x 970 IF n<>127 THEN LET c=c+ PEEK (start+n)  980 NEXT n 990 POKE start+15,t1000 DPOKE start+16,l1010 DPOKE start+18,a1020 DPOKE start+20,b1030 LET c=01040 FOR n=start TO start+221050 LET c=c+ PEEK n1060 NEXT n1070 LET c= FN m(c)1080 POKE start+127,c1090 GO TO #5,01100 FOR n=0 TO 1271110 PRINT #5; CHR$ PEEK (start+n);1120 NEXT n1130 CLOSE # 51140 LPRINT "OK."1150 LET files=files+1: LET bytes=bytes+l1160 GO TO %4501170 REM =======================1180 REM === Draw window =======1190 REM =======================1200 DEFPROC Window(row,col,row2,col2,t$)1210 PRINT AT row,col; PAPER 0; INK 7; BRIGHT 1;" ";t$;1220 FOR n=col+ LEN t$ TO col2-7: PRINT PAPER 0;" ";: NEXT n1230 PRINT PAPER 0; INK 2; BRIGHT 1;"";: PRINT PAPER 2; INK 6; BRIGHT 1;"";: PRINT PAPER 6; INK 4; BRIGHT 1;"";: PRINT PAPER 4; INK 5; BRIGHT 1;"";: PRINT PAPER 5; INK 0; BRIGHT 1;"";: PRINT PAPER 0;" ";1240 DIM s$(col2-col-1)1250 FOR n=row+1 TO row2-1: PRINT AT n,col; BRIGHT 1;"‘";s$;"’";: NEXT n1260 FOR n=1 TO LEN s$:s$(n)="”": NEXT n1270 PRINT AT row2,col; PAPER 7; INK 0; BRIGHT 1;"“";s$;"•";1280 ENDPROC 1290 REM =======================1300 REM === Message ===========1310 REM =======================1320 DEFPROC Message(b)1330 PRINT AT 8,1; PAPER 2; INK 7; BRIGHT b; FLASH b;"  LISTENING - Space to stop.  ";  1340 ENDPROC 1350 REM =======================1360 REM === Set directory =====1370 REM =======================1380 DEFPROC Directory()1390 SAVE "m:tapster.tmp" SCREEN$ 1400 .browse -k -p "Navigate with cursor keys, ENTER, EDIT and D.      Use K to create new directory and SPACE to confirm." p$1410 LOAD "m:tapster.tmp" SCREEN$ 1420 ERASE "m:tapster.tmp"1430 ENDPROC 1440 REM =======================1450 REM === Show help =========1460 REM =======================1470 DEFPROC Help()1480 LPRINT "This program helps you migrate your tapes to the ZX Spectrum Next's SD card or RAM disk. Select a target directory and you are ready to go. The maximum file size is 32K."''1490 LPRINT "There are options for overwriting existing files, fixing tape file names that would be invalid on disk, adding proper suffixes (such as .bas or .scr) and allowing headerless files."''1500 ENDPROC 1510 REM =======================1520 REM === Fix filename ======1530 REM =======================1540 DEFPROC DiskName(type,n$,size)1550 LOCAL c$,e$,f$,o$,c,n1560 IF NOT fixnames THEN LET o$=n$: GO TO %16201570 LET o$=""1580 FOR n=1 TO LEN n$1590 LET c$=n$(n)1600 IF c$>="0" AND c$<="9" OR c$>="A" AND c$<="Z" OR c$>="a" AND c$<="z" OR c$="#" OR c$="$" OR c$="@" OR c$="^" OR c$="_" OR c$="{" OR c$="}" OR c$="~" OR c$="`" THEN o$=o$+c$1610 NEXT n1620 IF o$="" THEN o$="Untitled"1630 LET e$=""1640 IF NOT suffix THEN GO TO %17001650 IF type=0 THEN LET e$=".bas": GO TO %17001660 IF type=1 THEN LET e$=".num": GO TO %17001670 IF type=2 THEN LET e$=".chr": GO TO %17001680 IF size=6912 THEN LET e$=".scr": GO TO %17001690 LET e$=".bin"1700 IF overwrite THEN LET f$=o$+e$: GO TO %17901710 ON ERROR GO TO %17801720 FOR c=0 TO 99991730 LET f$=o$1740 IF c<>0 THEN LET f$=f$+"-"+ STR$ (c)1750 LET f$=f$+e$1760 CLOSE # 5: OPEN # 5,"i>"+f$: CLOSE # 51770 NEXT c1780 ON ERROR 1790 ENDPROC =f$1800 REM =======================1810 REM === Setup ASM/UDGs ====1820 REM =======================1830 DEFPROC Pokes()1840 LET start=32768: LET %s=start1850 LET udg=start-1921860 LET check=udg-321870 LET tape=check-321880 DPOKE 23675,udg1890 POKE USR "a",1,3,7,15,31,63,127,2551900 POKE USR "b",128,128,128,128,128,128,128,1281910 POKE USR "c",1,1,1,1,1,1,1,11920 POKE USR "d",128,128,128,128,128,128,128,2551930 POKE USR "e",0,0,0,0,0,0,0,2551940 POKE USR "f",1,1,1,1,1,1,1,2551950 POKE tape,221,33,255,127,17,0,128,14,14,55,8,243,213,205,108,5,251,225,55,237,82,229,193,11,2011960 POKE check,33,255,127,17,0,0,1,0,0,19,122,179,200,120,134,71,121,174,79,35,27,24,255-121970 ENDPROC 