#program tapster  10 REM =======================  20 REM === Setup =============  30 REM =======================  40 RUN AT 3    50 CLEAR 32511  60 PROC Pokes()  70 PROC Window(1,1,6,30,"Tapster")    80 PROC Window(10,1,21,30,"0K in 0 file(s)")  90 CLOSE # 3: OPEN # 3,"w>11,2,10,28,4": LPRINT ; CHR$ 19; CHR$ 1; CHR$ 1; 100 LPRINT "Tapster Version 0.6" 110 LPRINT "(c) 2020 Joerg Pleumann" 120 LPRINT  130 DEF FN d(x)= INT (x/256) 140 DEF FN m(x)=x-256* INT (x/256) 150 PRINT AT 2,2; BRIGHT 1;"Start"," [X]Keep dupes"; 160 PRINT AT 3,2; BRIGHT 1;"Directory"," [X]Fix names"; 170 PRINT AT 4,2; BRIGHT 1;"Help"," [X]Add suffix"; 180 PRINT AT 5,2; BRIGHT 1;"Quit"," [X]Headerless"; 190 DIM o(4): LET o(1)=1: LET o(2)=1: LET o(3)=1: LET o(4)=1 200 LET mrow=0: LET mcol=0: LET mrow2=0: LET mcol2=0 210 LPRINT "Directory is ";: PWD #3 220 PROC FlashLight(0) 230 REM ======================= 240 REM === Menu navigation === 250 REM ======================= 260 POKE 22528+65+mrow*32+mcol*15,"xxxxxxxxxxxxxxx" 270 POKE 22528+65+mrow2*32+mcol2*15,"hhhhhhhhhhhhhhh" 280 LET mrow=mrow2: LET mcol=mcol2 290 PAUSE 0: LET k$= INKEY$ : BEEP 0.015,-20 300 IF k$= CHR$ 8 AND mcol>0 THEN mcol2=0: GO TO %260 310 IF k$= CHR$ 9 AND mcol<1 THEN mcol2=1: GO TO %260 320 IF k$= CHR$ 10 AND mrow<3 THEN mrow2=mrow+1: GO TO %260 330 IF k$= CHR$ 11 AND mrow>0 THEN mrow2=mrow-1: GO TO %260 340 IF k$<> CHR$ 13 THEN GO TO %290 350 IF mcol=1 THEN LET o(mrow+1)=1-o(mrow+1): PRINT AT 2+mrow,18; BRIGHT 1;" X"(o(mrow+1)+1);: GO TO %270 360 IF mrow=1 THEN PROC Directory(): GO TO %210 370 IF mrow=2 THEN PROC Help(): GO TO %280 380 IF mrow=3 THEN RUN AT 0: STOP  390 REM ======================= 400 REM === Main converter ==== 410 REM ======================= 420 PROC FlashLight(1) 430 CLOSE # 6: OPEN # 6,"u>tapster.txt": DIM #6 TO s: GO TO #6, s 440 LET bytes=0: LET files=0 450 LET dupes=o(1): LET fixnames=o(2): LET suffix=o(3): LET headerless=o(4) 460 PRINT AT 10,2; PAPER 0; INK 7; BRIGHT 1; INT (bytes/1024);"K in ";files;" file(s)     "; 470 RUN AT 0 480 LET e= USR tape 490 RUN AT 3 500 IF INKEY$ =" " THEN CLOSE # 6: GO TO %220 510 IF e>32768 THEN GO TO %470 515 LPRINT  520 DPOKE check+4,e 530 LET sum= USR check 540 IF PEEK (start+e)<> FN m(sum) THEN PROC LogPrint("Checksum error"): GO TO %470 550 IF PEEK (start-1)=0 AND e=17 THEN GO TO %650 560 IF PEEK (start-1)=0 OR headerless=0 THEN GO TO %460 580 LET t=5 590 LET n$="Headerless" 600 LET l=e 610 LET a=32768 620 LET b=32768 630 PROC LogPrint(n$+" (length="+ STR$ l+")") 640 GO TO %890 650 LET t= PEEK start 660 LET n$= PEEK$ (start+1,10) 670 LET l= % DPEEK (s+11) 680 LET a= % DPEEK (s+13) 690 LET b= % DPEEK (s+15) 700 IF LEN (n$)<>0 THEN IF n$( LEN n$)=" " THEN n$=n$( TO LEN n$-1): GO TO %700 720 IF t=0 THEN LET t$= "Program: ": ELSE IF t=1 THEN LET t$= "Numeric array: ": ELSE IF t=2 THEN LET t$= "Character array: ": ELSE LET t$="Bytes: " 730 LET t$=t$+n$+" (size "+ STR$ l 740 IF t=0 AND (a<=9999) THEN LET t$=t$+", line " + STR$ a 750 IF t=0 AND b<l THEN LET t$=t$+", vars" 760 IF t=1 OR t=2 THEN LET %n=a: LET nn=%((n/256)&31)+96: LET t$=t$+", name "+ CHR$ nn: IF t=2 THEN LET t$=t$+"$" 770 IF t=4 THEN LET t$=t$+", addr "+ STR$ a 780 LET t$=t$+ ")" 790 PROC LogPrint(t$) 800 IF t=5 THEN GO TO %890 810 RUN AT 0 820 LET e= USR tape 830 RUN AT 3 840 IF INKEY$ =" " THEN CLOSE # 6: GO TO %220 850 IF e<>l THEN PROC LogPrint("Length error"): GO TO %470 860 DPOKE check+4,e 870 LET sum= USR check 880 IF PEEK (start+e)<> FN m(sum) THEN PROC LogPrint("Checksum error"): GO TO %470 890 BORDER 7 900 ON ERROR ERROR TO err: PROC LogPrint("Error: "+ STR$ err): ON ERROR : GO TO %460 910 PROC DiskName(t,n$,l) TO n$ 920 LET z$="Saving as """+n$+"""...": PROC LogPrint(z$) 930 SAVE n$ CODE start,l 940 CLOSE # 5 950 OPEN # 5,"u>"+n$ 960 LET c=0 970 FOR n=0 TO 127 980 NEXT #5 TO %x 990 POKE start+n,%x1000 IF n<>127 THEN LET c=c+ PEEK (start+n) 1010 NEXT n1020 POKE start+15,t1030 DPOKE start+16,l1040 DPOKE start+18,a1050 DPOKE start+20,b1060 LET c=01070 FOR n=start TO start+221080 LET c=c+ PEEK n1090 NEXT n1100 LET c= FN m(c)1110 POKE start+127,c1120 GO TO #5,01130 FOR n=0 TO 1271140 PRINT #5; CHR$ PEEK (start+n);1150 NEXT n1160 CLOSE # 51170 PROC LogPrint("OK")1180 LET files=files+1: LET bytes=bytes+l1190 ON ERROR 1200 GO TO %4601210 REM =======================1220 REM === Draw window =======1230 REM =======================1240 DEFPROC Window(row,col,row2,col2,t$)1250 PRINT AT row,col; PAPER 0; INK 7; BRIGHT 1;" ";t$;1260 FOR n=col+ LEN t$ TO col2-7: PRINT PAPER 0;" ";: NEXT n1270 PRINT PAPER 0; INK 2; BRIGHT 1;"";: PRINT PAPER 2; INK 6; BRIGHT 1;"";: PRINT PAPER 6; INK 4; BRIGHT 1;"";: PRINT PAPER 4; INK 5; BRIGHT 1;"";: PRINT PAPER 5; INK 0; BRIGHT 1;"";: PRINT PAPER 0;" ";1280 DIM s$(col2-col-1)1290 FOR n=row+1 TO row2-1: PRINT AT n,col; BRIGHT 1;"‘";s$;"’";: NEXT n1300 FOR n=1 TO LEN s$:s$(n)="”": NEXT n1310 PRINT AT row2,col; PAPER 7; INK 0; BRIGHT 1;"“";s$;"•";1320 ENDPROC 1330 REM =======================1340 REM === Show progress =====1350 REM =======================1360 DEFPROC LogPrint(m$)1370 LPRINT m$1380 PROC DateTime() TO t$1390 PRINT #6;t$;" ";m$1400 ENDPROC 1410 REM =======================1420 REM == Date and time ======1430 REM =======================1440 DEFPROC DateTime()1450 LOCAL a$1460 DIM b$(48)1470 OPEN # 2,"v>b$"1480 ON ERROR GO TO %15101490 .date:.time1500 LET a$=b$(13 TO 22)+" "+b$(37 TO 44)+" "1510 CLOSE # 2 1520 ENDPROC = a$1530 REM =======================1540 REM === Red flashlight ====1550 REM =======================1560 DEFPROC FlashLight(b)1570 PRINT AT 8,1; PAPER 2; INK 7; BRIGHT b; FLASH b;"  LISTENING - Space to stop.  ";1580 ENDPROC 1590 REM =======================1600 REM === Set directory =====1610 REM =======================1620 DEFPROC Directory()1630 SAVE "m:tapster.tmp" SCREEN$ 1640 .browse -k -p "Navigate with cursor keys, ENTER, EDIT and D.      Use K to create new directory and SPACE to confirm." p$1650 LOAD "m:tapster.tmp" SCREEN$ 1660 ERASE "m:tapster.tmp"1670 ENDPROC 1680 REM =======================1690 REM === Show help =========1700 REM =======================1710 DEFPROC Help()1720 LPRINT '"This program helps you migrate your tapes to the ZX Spectrum Next's SD card or RAM disk. Select a target directory and you are ready to go. The maximum file size is 32K."''1730 LPRINT "There are options for overwriting existing files, fixing tape file names that would be invalid on disk, adding proper suffixes (such as .bas or .scr) and allowing headerless files."1740 ENDPROC 1750 REM =======================1760 REM === Fix filename ======1770 REM =======================1780 DEFPROC DiskName(type,n$,size)1790 LOCAL c$,e$,f$,o$,c,n1800 IF NOT fixnames THEN LET o$=n$: GO TO %18601810 LET o$=""1820 FOR n=1 TO LEN n$1830 LET c$=n$(n)1840 IF c$>="0" AND c$<="9" OR c$>="A" AND c$<="Z" OR c$>="a" AND c$<="z" OR c$="#" OR c$="$" OR c$="@" OR c$="^" OR c$="_" OR c$="{" OR c$="}" OR c$="~" OR c$="`" THEN o$=o$+c$1850 NEXT n1860 IF o$="" THEN o$="Untitled"1870 LET e$=""1880 IF NOT suffix THEN GO TO %19301890 IF type=0 THEN LET e$=".bas": GO TO %19301900 IF type=1 THEN LET e$=".num": GO TO %19301910 IF type=2 THEN LET e$=".chr": GO TO %19301920 IF size=6912 THEN LET e$=".scr": ELSE LET e$=".bin"1930 IF NOT dupes THEN LET f$=o$+e$: GO TO %20201940 ON ERROR GO TO %20101950 FOR c=0 TO 99991960 LET f$=o$1970 IF c<>0 THEN LET f$=f$+"-"+ STR$ (c)1980 LET f$=f$+e$1990 CLOSE # 5: OPEN # 5,"i>"+f$: CLOSE # 52000 NEXT c2010 ON ERROR 2020 ENDPROC =f$2030 REM =======================2040 REM === Poke MC & UDGs ====2050 REM =======================2060 DEFPROC Pokes()2070 LET start=32768: LET %s=start2080 LET udg=start-1922090 LET check=udg-322100 LET tape=check-322110 DPOKE 23675,udg2120 POKE USR "a",1,3,7,15,31,63,127,2552130 POKE USR "b",128,128,128,128,128,128,128,1282140 POKE USR "c",1,1,1,1,1,1,1,12150 POKE USR "d",128,128,128,128,128,128,128,2552160 POKE USR "e",0,0,0,0,0,0,0,2552170 POKE USR "f",1,1,1,1,1,1,1,2552180 POKE tape,221,33,255,127,17,0,128,14,14,55,8,243,213,205,108,5,251,225,55,237,82,229,193,11,2012190 POKE check,33,255,127,17,0,0,1,0,0,19,122,179,200,120,134,71,121,174,79,35,27,24,255-122200 ENDPROC 